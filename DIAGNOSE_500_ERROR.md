# üîç 500 Error - Root Cause Analysis

## ‚úÖ What We Know So Far

1. **Environment Variables**: ‚úÖ ALL SET CORRECTLY
   - `SUPABASE_URL`: ‚úÖ Set
   - `SUPABASE_ANON_KEY`: ‚úÖ Set  
   - All Sanity variables: ‚úÖ Set

2. **Vercel Deployment**: ‚úÖ Working
   - Site is live at https://hi-fdah.vercel.app
   - Auto-deployment from GitHub working

3. **The Problem**: Contact form returns 500 Internal Server Error

---

## üéØ Next Step: Check Supabase Verification

I've deployed a verification endpoint that will tell us EXACTLY what's wrong.

### Wait for Deployment (2-3 minutes)

Vercel is currently deploying. Wait a few minutes, then visit:

```
https://hi-fdah.vercel.app/api/verify-supabase
```

### What You'll See

The endpoint will show one of these results:

#### ‚úÖ Success Response
```json
{
  "status": "success",
  "message": "Supabase connection working perfectly!",
  "tableRecordCount": 4,
  "testInsertSuccess": true
}
```
**Meaning**: Supabase is working! The issue is elsewhere.

#### ‚ùå Table Doesn't Exist
```json
{
  "status": "error",
  "error": "relation \"contact_submissions\" does not exist",
  "code": "42P01"
}
```
**Meaning**: The Supabase table hasn't been created yet.

**FIX**:
1. Go to Supabase Dashboard ‚Üí SQL Editor
2. Copy the SQL from `supabase/schema.sql`
3. Paste and run it
4. Test again

#### ‚ùå Permission Error
```json
{
  "status": "table_exists_but_insert_failed",
  "insertError": "new row violates row-level security policy",
  "tableRecordCount": 4
}
```
**Meaning**: Table exists but RLS policy is blocking inserts.

**FIX**:
1. Go to Supabase Dashboard ‚Üí Authentication ‚Üí Policies
2. Make sure the "Allow anonymous inserts" policy exists
3. Or run the full schema from `supabase/schema.sql`

#### ‚ùå Wrong Credentials
```json
{
  "status": "error",
  "error": "Invalid API key",
  "code": "PGRST301"
}
```
**Meaning**: The Supabase anon key is incorrect.

**FIX**:
1. Go to Supabase Dashboard ‚Üí Settings ‚Üí API
2. Copy the fresh "anon public" key
3. Update in Vercel environment variables
4. Redeploy

---

## üìã Action Plan

### Step 1: Wait for Deployment
- Check Vercel dashboard for deployment status
- Should complete in 2-3 minutes

### Step 2: Visit Verification Endpoint
```
https://hi-fdah.vercel.app/api/verify-supabase
```

### Step 3: Based on the Response

**If "Table doesn't exist"**:
- Run SQL schema in Supabase
- File: `supabase/schema.sql`

**If "Permission error"**:
- Check RLS policies in Supabase
- Re-run the full schema

**If "Wrong credentials"**:
- Update Supabase anon key in Vercel
- Redeploy

**If "Success"**:
- The issue is in the contact form code
- Check Vercel function logs for `/api/contact`

---

## üîß Quick Fixes

### Fix 1: Create Supabase Table

1. Go to https://supabase.com/dashboard
2. Select your project
3. SQL Editor ‚Üí New query
4. Paste this:

```sql
-- Create contact_submissions table
CREATE TABLE IF NOT EXISTS contact_submissions (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  name TEXT NOT NULL,
  email TEXT NOT NULL,
  message TEXT NOT NULL
);

-- Enable Row Level Security
ALTER TABLE contact_submissions ENABLE ROW LEVEL SECURITY;

-- Create policy to allow anonymous inserts
CREATE POLICY "Allow anonymous inserts" ON contact_submissions
  FOR INSERT
  TO anon
  WITH CHECK (true);

-- Create policy to allow service role to view all
CREATE POLICY "Allow service role to view all" ON contact_submissions
  FOR SELECT
  TO service_role
  USING (true);
```

5. Click "Run"
6. Verify table appears in Table Editor

### Fix 2: Check Vercel Function Logs

1. Go to https://vercel.com/dashboard
2. Click your project
3. Click "Logs" or "Functions"
4. Look for `/api/contact` errors
5. The error message will tell you exactly what's wrong

---

## üéØ Most Likely Issue

Based on the symptoms, the most likely cause is:

**The `contact_submissions` table doesn't exist in Supabase**

This would cause:
- ‚úÖ Environment variables check passes
- ‚úÖ Supabase connection works
- ‚ùå Insert fails with "table doesn't exist" error
- ‚ùå 500 error returned to user

**Solution**: Run the SQL schema in Supabase (see Fix 1 above)

---

## üìû What to Share

Once you check the verification endpoint, share with me:

1. **Verification response**: What does `/api/verify-supabase` show?
2. **Supabase table status**: Does `contact_submissions` exist in Table Editor?
3. **Vercel logs**: Any error messages in function logs?

With this info, I can give you the exact fix! üöÄ

---

**Next**: Wait 2-3 minutes for deployment, then check the verification endpoint!
